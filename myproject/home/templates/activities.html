{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nearby Recreational Activities</title>

  <!-- Local stylesheet -->
  <link rel="stylesheet" href="{% static 'styles.css' %}" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
</head>

<body>
  <!-- Top navigation bar -->
  <nav class="navbar">
    <div class="navbar-content">
      <a href="{% url 'index' %}" class="site-logo-link">
        <img src="{% static 'recreo.jpg' %}" alt="Recreo Logo" class="nav-logo" />
      </a>

      <ul class="nav-menu">
        <li><a href="{% url 'index' %}">Home</a></li>
        <li><a href="#">Activities</a></li>
        <li><a href="#">Contact</a></li>
      </ul>

      <div class="navbar-extra">Your adventure awaits</div>
    </div>
  </nav>

  <main class="content-wrapper">
    <section class="activities-header">
      <h1>Recreational Activities Near You</h1>
      {% if coords.city and coords.state %}
        <h2>Activities in {{ coords.city }}, {{ coords.state }}</h2>
      {% else %}
        <h2>Activities Near Your Location</h2>
      {% endif %}
    </section>

    {% if activities %}
      <ul class="activities-list">
        {% for activity in activities %}
          <li class="activity-item">
            <a href="{% url 'activity_detail' activity.name %}">
              <strong>{{ activity.name }}</strong>
            </a><br />
            <span>{{ activity.description }}</span><br />
            <em>{{ activity.location }}</em><br />
            <small>{{ activity.distance_miles }} miles away</small>
          </li>
        {% endfor %}

      </ul>
    {% else %}
      <p>No activities found yet for your location.</p>
    {% endif %}

    <section class="weather-section">
      <div class="weather-container">
        <div class="current-weather">
          <h3>Current Weather</h3>
          <div id="current-weather-content">
            <p class="loading">Loading weather...</p>
          </div>
        </div>

        <div class="forecast-weather">
          <h3>4-Day Forecast</h3>
          <div id="forecast-content" class="forecast-grid">
            <p class="loading">Loading forecast...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Map container -->
  <div id="map-container">
    <div id="map"></div>
  </div>

  <footer>
    <p>Created by Team 5 - 10/6/25</p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    let userLat, userLon;
    document.addEventListener("DOMContentLoaded", () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
                (position) => {
                  userLat = position.coords.latitude;
                  userLon = position.coords.longitude;
                  showMap(position);
                  fetchWeather(userLat, userLon);
                },
                showError
        );
      } else {
        console.log("Geolocation not supported by this browser.");
      }
    });

    function showMap(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      const map = L.map("map").setView([lat, lon], 13);

      // Add OpenStreetMap tiles
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
        maxZoom: 19
      }).addTo(map);

      // Add user's blue marker
      L.marker([lat, lon], {
        icon: L.icon({
          iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          iconSize: [32, 32],
          iconAnchor: [16, 32]
        })
      }).addTo(map)
 

      // Activity markers
      const activities = [
        {% for activity in activities %}
          {
            name: "{{ activity.name|escapejs }}",
            description: "{{ activity.description|escapejs }}",
            lat: {{ activity.lat|default:0 }},
            lon: {{ activity.lon|default:0 }}
          },
        {% endfor %}
      ];

      activities.forEach((act) => {
        if (act.lat && act.lon) {
          L.marker([act.lat, act.lon], {
            icon: L.icon({
              iconUrl: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
              iconSize: [32, 32],
              iconAnchor: [16, 32]
            })
          })
            .addTo(map)
            .bindPopup(`<b>${act.name}</b><br>${act.description}`);
        }
      });

      // Fix for hidden map rendering
      setTimeout(() => map.invalidateSize(), 300);
    }

    function showError(error) {
      console.warn("Geolocation error:", error.message);
    }

    async function fetchWeather(lat, lon) {
      if (!lat || !lon || lat === 0 || lon === 0) {
        console.log('Invalid coordinates, skipping weather fetch');
        return;
      }
      try {
        const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&wind_speed_unit=mph&timezone=auto`;

        const response = await fetch(weatherUrl);
        const data = await response.json();

        displayCurrentWeather(data.current);
        displayForecast(data.daily);
      } catch (error) {
        console.error("Error fetching weather:", error);
        document.getElementById("current-weather-content").innerHTML =
                '<p class="loading">Unable to load weather data</p>';
        document.getElementById("forecast-content").innerHTML =
                '<p class="loading">Unable to load forecast</p>';
      }
    }

    function getWeatherIcon(code) {
      const icons = {
        0: 'â˜€ï¸', 1: 'ğŸŒ¤ï¸', 2: 'â›…', 3: 'â˜ï¸',
        45: 'ğŸŒ«ï¸', 48: 'ğŸŒ«ï¸',
        51: 'ğŸŒ¦ï¸', 53: 'ğŸŒ¦ï¸', 55: 'ğŸŒ¦ï¸',
        61: 'ğŸŒ§ï¸', 63: 'ğŸŒ§ï¸', 65: 'ğŸŒ§ï¸',
        71: 'ğŸŒ¨ï¸', 73: 'ğŸŒ¨ï¸', 75: 'ğŸŒ¨ï¸',
        77: 'â„ï¸', 80: 'ğŸŒ¦ï¸', 81: 'ğŸŒ§ï¸', 82: 'â›ˆï¸',
        85: 'ğŸŒ¨ï¸', 86: 'ğŸŒ¨ï¸',
        95: 'â›ˆï¸', 96: 'â›ˆï¸', 99: 'â›ˆï¸'
      };
      return icons[code] || 'ğŸŒ¤ï¸';
    }

    function getWeatherDescription(code) {
      const descriptions = {
        0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
        45: 'Foggy', 48: 'Foggy',
        51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',
        61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
        71: 'Slight snow', 73: 'Moderate snow', 75: 'Heavy snow',
        77: 'Snow grains', 80: 'Rain showers', 81: 'Rain showers', 82: 'Heavy rain showers',
        85: 'Snow showers', 86: 'Heavy snow showers',
        95: 'Thunderstorm', 96: 'Thunderstorm with hail', 99: 'Severe thunderstorm'
      };
      return descriptions[code] || 'Unknown';
    }

    function displayCurrentWeather(current) {
      const html = `
    <div class="weather-icon">${getWeatherIcon(current.weather_code)}</div>
    <div class="weather-details">
      <div class="weather-temp">${Math.round(current.temperature_2m)}Â°F</div>
      <div class="weather-description">${getWeatherDescription(current.weather_code)}</div>
      <div class="weather-extra">
        <span>Feels like: ${Math.round(current.apparent_temperature)}Â°F</span>
        <span>Humidity: ${current.relative_humidity_2m}%</span>
        <span>Wind: ${Math.round(current.wind_speed_10m)} mph</span>
      </div>
    </div>
  `;
      document.getElementById("current-weather-content").innerHTML = html;
    }

    function displayForecast(daily) {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      let html = '';

      for (let i = 2; i <= 5; i++) {
        const date = new Date(daily.time[i]);
        const dayName = days[date.getDay()];
        const monthDay = `${date.getMonth() + 1}/${date.getDate()}`;

        html += `
      <div class="forecast-day">
        <div class="forecast-date">${dayName}<br><small>${monthDay}</small></div>
        <div class="forecast-icon">${getWeatherIcon(daily.weather_code[i])}</div>
        <div class="forecast-temp">
          <strong>${Math.round(daily.temperature_2m_max[i])}Â°</strong> / ${Math.round(daily.temperature_2m_min[i])}Â°
        </div>
        <div class="forecast-desc">${getWeatherDescription(daily.weather_code[i])}</div>
      </div>
    `;
      }

      document.getElementById("forecast-content").innerHTML = html;
    }
  </script>
</body>
</html>
